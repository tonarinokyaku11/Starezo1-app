/* ============================================================
   â–¼ 1. è·æ¥­ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆ16ãƒ“ãƒ«ãƒ‰ Ã— ğŸ‘ãŠã™ã™ã‚ã‚³ã‚¢ï¼‰
   ============================================================ */

const jobPresets = {
  "ãƒ“ãƒ¼ãƒˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ¼": {
    builds: {
      "ç‹‚éŸ³å‹": [
        "çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦",
        "é›†ä¸­ãƒ»å¹¸é‹","æ¥µãƒ»HPå‡ç¸®","æ¥µãƒ»å¿œæ€¥å‡¦ç½®","æ¥µãƒ»å¹¸é‹ä¼šå¿ƒ",
        "ç­‹åŠ›å¼·åŒ–","æ•æ·å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ",
        "é­”æ³•è€æ€§","ç‰©ç†è€æ€§","é›†ä¸­ãƒ»è© å”±"
      ],
      "éŸ¿å¥å‹": [
        "ç‰¹æ”»å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»ä¼šå¿ƒ","æ¥µãƒ»å¹¸é‹ä¼šå¿ƒ","çŸ¥åŠ›å¼·åŒ–","é­”æ³•è€æ€§",
        "ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","æ¥µãƒ»HPå‡ç¸®","ç­‹åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–",
        "ç‰©ç†è€æ€§","é›†ä¸­ãƒ»è© å”±","æ¥µãƒ»å¿œæ€¥å‡¦ç½®","æ•æ·å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ",
        "é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦"
      ]
    }
  },

  "ã‚·ãƒ¼ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ã‚¿ãƒ¼": {
    builds: {
      "å…‰ç •å‹": [
        "é­”æ³•è€æ€§","ç‰©ç†è€æ€§","æ¥µãƒ»HPå‡ç¸®","æ¥µãƒ»çµ¶å¢ƒå®ˆè­·","æ¥µãƒ»HPå¸å",
        "æ¥µãƒ»HPå¤‰å‹•","ç­‹åŠ›å¼·åŒ–","æ•æ·å¼·åŒ–","çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–",
        "ç²¾é‹­æ‰“æ’ƒ","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»è© å”±",
        "é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦"
      ],
      "å…‰ç›¾å‹": [
        "é­”æ³•è€æ€§","ç‰©ç†è€æ€§","æ¥µãƒ»HPå‡ç¸®","æ¥µãƒ»çµ¶å¢ƒå®ˆè­·","æ¥µãƒ»HPå¤‰å‹•",
        "æ¥µãƒ»HPå¸å","ç­‹åŠ›å¼·åŒ–","æ•æ·å¼·åŒ–","çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–",
        "ç²¾é‹­æ‰“æ’ƒ","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»è© å”±",
        "é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦"
      ]
    }
  },

  "ãƒ‡ã‚£ãƒã‚¤ãƒ³ã‚¢ãƒ¼ãƒãƒ£ãƒ¼": {
    builds: {
      "ç‹¼å¼“å‹": [
        "æ•æ·å¼·åŒ–","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦","ç­‹åŠ›å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–",
        "é›†ä¸­ãƒ»è© å”±","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","çŸ¥åŠ›å¼·åŒ–",
        "é­”æ³•è€æ€§","é›†ä¸­ãƒ»ä¼šå¿ƒ","ç²¾é‹­æ‰“æ’ƒ","æ¥µãƒ»é©å¿œåŠ›",
        "ç‰¹æ”»å›å¾©å¼·åŒ–","ç‰©ç†è€æ€§","é›†ä¸­ãƒ»å¹¸é‹"
      ],
      "é·¹å¼“å‹": [
        "æ•æ·å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦",
        "é›†ä¸­ãƒ»ä¼šå¿ƒ","é›†ä¸­ãƒ»å¹¸é‹","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","æ¥µãƒ»é©å¿œåŠ›",
        "ç­‹åŠ›å¼·åŒ–","çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–",
        "é­”æ³•è€æ€§","ç‰©ç†è€æ€§","é›†ä¸­ãƒ»è© å”±"
      ]
    }
  },

  "ãƒ˜ãƒ´ã‚£ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³": {
    builds: {
      "å‰›èº«å‹": [
        "é­”æ³•è€æ€§","ç­‹åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–",
        "é›†ä¸­ãƒ»ä¼šå¿ƒ","ç‰©ç†è€æ€§","æ•æ·å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é›†ä¸­ãƒ»è© å”±",
        "é›†ä¸­ãƒ»å¹¸é‹","æ¥µãƒ»çµ¶å¢ƒå®ˆè­·","çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–",
        "é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·"
      ],
      "å‰›å®ˆå‹": [
        "é­”æ³•è€æ€§","ç‰©ç†è€æ€§","æ¥µãƒ»çµ¶å¢ƒå®ˆè­·","ç­‹åŠ›å¼·åŒ–","çŸ¥åŠ›å¼·åŒ–",
        "ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–",
        "é›†ä¸­ãƒ»å¹¸é‹","æ•æ·å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é›†ä¸­ãƒ»è© å”±",
        "é›†ä¸­ãƒ»ä¼šå¿ƒ","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦"
      ]
    }
  },

  "ãƒ´ã‚¡ãƒ¼ãƒ€ãƒ³ãƒˆã‚ªãƒ©ã‚¯ãƒ«": {
    builds: {
      "å¨å’²å‹": [
        "çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»å¹¸é‹",
        "æ¥µãƒ»HPå‡ç¸®","æ¥µãƒ»å¿œæ€¥å‡¦ç½®","æ¥µãƒ»å¹¸é‹ä¼šå¿ƒ","ç­‹åŠ›å¼·åŒ–",
        "æ•æ·å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é­”æ³•è€æ€§",
        "ç‰©ç†è€æ€§","é›†ä¸­ãƒ»è© å”±","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦"
      ],
      "æ£®ç™’å‹": [
        "ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»è© å”±","æ¥µãƒ»HPå‡ç¸®",
        "æ¥µãƒ»å¿œæ€¥å‡¦ç½®","æ¥µãƒ»å¹¸é‹ä¼šå¿ƒ","ç­‹åŠ›å¼·åŒ–","æ•æ·å¼·åŒ–",
        "çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é­”æ³•è€æ€§",
        "ç‰©ç†è€æ€§","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦","é›†ä¸­ãƒ»ä¼šå¿ƒ"
      ]
    }
  },

  "ã‚²ã‚¤ãƒ«ãƒ©ãƒ³ã‚µãƒ¼": {
    builds: {
      "çƒˆé¢¨å‹": [
        "ç­‹åŠ›å¼·åŒ–","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦","æ¥µãƒ»HPå¤‰å‹•","ç‰¹æ”»å›å¾©å¼·åŒ–",
        "ç‰©ç†è€æ€§","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","æ•æ·å¼·åŒ–",
        "ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","æ¥µãƒ»é©å¿œåŠ›","çŸ¥åŠ›å¼·åŒ–",
        "é­”æ³•è€æ€§","é›†ä¸­ãƒ»è© å”±","é›†ä¸­ãƒ»ä¼šå¿ƒ"
      ],
      "ä¹±é¢¨å‹": [
        "ç­‹åŠ›å¼·åŒ–","é›†ä¸­ãƒ»ä¼šå¿ƒ","æ¥µãƒ»é©å¿œåŠ›","çŸ¥åŠ›å¼·åŒ–","é­”æ³•è€æ€§",
        "ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","é›†ä¸­ãƒ»å¹¸é‹","æ¥µãƒ»HPå¤‰å‹•","ç‰¹æ”»å›å¾©å¼·åŒ–",
        "ç²¾é‹­æ‰“æ’ƒ","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","æ•æ·å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–",
        "é›†ä¸­ãƒ»è© å”±"
      ]
    }
  },

  "ãƒ•ãƒ­ã‚¹ãƒˆãƒ¡ã‚¤ã‚¸": {
    builds: {
      "æ°·ç‰™å‹": [
        "çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é›†ä¸­ãƒ»è© å”±",
        "é›†ä¸­ãƒ»ä¼šå¿ƒ","é›†ä¸­ãƒ»å¹¸é‹","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","æ¥µãƒ»é©å¿œåŠ›",
        "ç­‹åŠ›å¼·åŒ–","æ•æ·å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–",
        "é­”æ³•è€æ€§","ç‰©ç†è€æ€§","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦"
      ],
      "éœœå¤©å‹": [
        "çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é›†ä¸­ãƒ»è© å”±",
        "æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","æ¥µãƒ»é©å¿œåŠ›","ç­‹åŠ›å¼·åŒ–","æ•æ·å¼·åŒ–",
        "ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é­”æ³•è€æ€§","ç‰©ç†è€æ€§",
        "é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦","é›†ä¸­ãƒ»ä¼šå¿ƒ","é›†ä¸­ãƒ»å¹¸é‹"
      ]
    }
  },

  "ã‚¹ãƒˆãƒ¼ãƒ ãƒ–ãƒ¬ã‚¤ãƒ‰": {
    builds: {
      "é›·åˆƒå‹": [
        "æ•æ·å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","é›†ä¸­ãƒ»ä¼šå¿ƒ",
        "æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","æ¥µãƒ»é©å¿œåŠ›","æ¥µãƒ»HPå¤‰å‹•","ç­‹åŠ›å¼·åŒ–",
        "çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–","ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é­”æ³•è€æ€§",
        "ç‰©ç†è€æ€§","é›†ä¸­ãƒ»è© å”±","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦"
      ],
      "æœˆå½±å‹": [
        "æ•æ·å¼·åŒ–","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦","æ¥µãƒ»é©å¿œåŠ›","çŸ¥åŠ›å¼·åŒ–",
        "é­”æ³•è€æ€§","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","é›†ä¸­ãƒ»å¹¸é‹","æ¥µãƒ»HPå¤‰å‹•",
        "ç‰¹æ”»å›å¾©å¼·åŒ–","ç²¾é‹­æ‰“æ’ƒ","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","ç­‹åŠ›å¼·åŒ–",
        "ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»è© å”±"
      ]
    }
  }
};


/* ============================================================
   â–¼ 2. UI åˆæœŸåŒ–
   ============================================================ */

window.onload = () => {
  initJobSelect();
  initPrioritySelect();
  updateLinkInputs();
};


/* ============================================================
   â–¼ 3. è·æ¥­ â†’ ãƒ“ãƒ«ãƒ‰å¤‰æ›´
   ============================================================ */

function initJobSelect() {
  const jobSelect = document.getElementById("jobSelect");
  jobSelect.innerHTML = Object.keys(jobPresets)
    .map(j => `<option value="${j}">${j}</option>`)
    .join("");

  onJobChange();
}

function onJobChange() {
  const job = document.getElementById("jobSelect").value;
  const buildSelect = document.getElementById("buildSelect");

  const builds = Object.keys(jobPresets[job].builds);
  buildSelect.innerHTML = builds.map(b => `<option value="${b}">${b}</option>`).join("");

  onBuildChange();
}


/* ============================================================
   â–¼ 4. ãƒ“ãƒ«ãƒ‰å¤‰æ›´ â†’ ãŠã™ã™ã‚ã‚³ã‚¢ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ
   ============================================================ */

function onBuildChange() {
  const job = document.getElementById("jobSelect").value;
  const build = document.getElementById("buildSelect").value;

  const recommended = jobPresets[job].builds[build];

  const box = document.getElementById("recommendedFilterBox");
  box.innerHTML = recommended
    .map(core => `
      <label style="display:block;">
        <input type="checkbox" class="recCheck" value="${core}">
        ${core}
      </label>
    `)
    .join("");

  renderResults();
}


/* ============================================================
   â–¼ 5. æœ€å„ªå…ˆãƒ‘ãƒ¯ãƒ¼ã‚³ã‚¢ã®å¾©æ´»
   ============================================================ */

const powerCoreList = [
  "ç­‹åŠ›å¼·åŒ–","æ•æ·å¼·åŒ–","çŸ¥åŠ›å¼·åŒ–","ç‰¹æ”»ãƒ€ãƒ¡ãƒ¼ã‚¸å¼·åŒ–","ç‰¹æ”»å›å¾©å¼·åŒ–",
  "ãƒã‚¹ã‚¿ãƒªãƒ¼å›å¾©å¼·åŒ–","é›†ä¸­ãƒ»æ”»æ’ƒé€Ÿåº¦","é›†ä¸­ãƒ»ä¼šå¿ƒ","é›†ä¸­ãƒ»å¹¸é‹",
  "é›†ä¸­ãƒ»è© å”±","é­”æ³•è€æ€§","ç‰©ç†è€æ€§","ç²¾é‹­æ‰“æ’ƒ","æ¥µãƒ»HPå‡ç¸®",
  "æ¥µãƒ»å¿œæ€¥å‡¦ç½®","æ¥µãƒ»å¹¸é‹ä¼šå¿ƒ","æ¥µãƒ»çµ¶å¢ƒå®ˆè­·","æ¥µãƒ»HPå¸å",
  "æ¥µãƒ»HPå¤‰å‹•","æ¥µãƒ»ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¼·","æ¥µãƒ»é©å¿œåŠ›"
];

function initPrioritySelect() {
  const sel = document.getElementById("priority");
  sel.innerHTML = powerCoreList.map(x => `<option value="${x}">${x}</option>`).join("");
}


/* ============================================================
   â–¼ 6. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²ç”»é¢ã®å¾©æ´»
   ============================================================ */

function updateLinkInputs() {
  const rarity = document.getElementById("rarity").value;
  const box = document.getElementById("links");

  const count = rarity === "gold" ? 3 : 2;

  box.innerHTML = "";

  for (let i = 1; i <= count; i++) {
    box.innerHTML += `
      <div class="link-set">
        <select id="link${i}type">
          ${powerCoreList.map(x => `<option value="${x}">${x}</option>`).join("")}
        </select>
        <input id="link${i}level" type="number" min="1" max="20" value="1">
      </div>
    `;
  }
}

document.getElementById("rarity").addEventListener("change", updateLinkInputs);


/* ============================================================
   â–¼ 7. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²
   ============================================================ */

let modules = [];
let moduleId = 0;

function addModule() {
  if (modules.length >= 300) {
    alert("ç™»éŒ²ã¯300å€‹ã¾ã§ã§ã™");
    return;
  }

  const rarity = document.getElementById("rarity").value;
  const count = rarity === "gold" ? 3 : 2;

  const links = [];
  for (let i = 1; i <= count; i++) {
    const type = document.getElementById(`link${i}type`).value;
    const level = Number(document.getElementById(`link${i}level`).value);
    links.push({ type, level });
  }

  modules.push({ id: moduleId++, rarity, links });
  renderModules();
}

function renderModules() {
  const box = document.getElementById("moduleList");
  box.innerHTML = modules
    .map(m => `
      <div class="card">
        <b>${m.rarity === "gold" ? "é‡‘" : "ç´«"}</b><br>
        ${m.links.map(l => `${l.type} Lv${l.level}`).join("<br>")}
      </div>
    `)
    .join("");
}
/* ============================================================
   â–¼ 8. è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ3ã¤ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ„ã¿åˆã‚ã›ï¼‰
   ============================================================ */

let results = [];

function calculate() {
  results = [];

  if (modules.length < 3) {
    alert("3ã¤ä»¥ä¸Šç™»éŒ²ã—ã¦ãã ã•ã„");
    return;
  }

  const job = document.getElementById("jobSelect").value;
  const build = document.getElementById("buildSelect").value;
  const recommended = jobPresets[job].builds[build];

  // 3ã¤ã®çµ„ã¿åˆã‚ã›
  for (let i = 0; i < modules.length; i++) {
    for (let j = i + 1; j < modules.length; j++) {
      for (let k = j + 1; k < modules.length; k++) {

        const arr = [modules[i], modules[j], modules[k]];

        // â–¼ 16ä»¥ä¸Šã®ã‚³ã‚¢é›†è¨ˆ
        const map = {};
        arr.forEach(m => {
          m.links.forEach(l => {
            map[l.type] = (map[l.type] || 0) + l.level;
          });
        });

        const core16 = Object.entries(map)
          .filter(([_, v]) => v >= 16)
          .map(([k, v]) => ({ type: k, level: v }));

        if (core16.length === 0) continue;

        results.push({
          modules: arr,
          core16,
          coreCount: core16.length
        });
      }
    }
  }

  renderResults();
}


/* ============================================================
   â–¼ 9. AND æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸãŠã™ã™ã‚ã‚³ã‚¢ã‚’å…¨éƒ¨å«ã‚€ï¼‰
   ============================================================ */

function getCheckedRecommended() {
  return [...document.querySelectorAll(".recCheck")]
    .filter(c => c.checked)
    .map(c => c.value);
}


/* ============================================================
   â–¼ 10. ä¸¦ã³æ›¿ãˆï¼ˆcoreCount â†’ åå‰é †ï¼‰
   ============================================================ */

function sortResults(arr) {
  return arr.sort((a, b) => {
    // â‘  coreCountï¼ˆ16ä»¥ä¸Šã®ã‚³ã‚¢æ•°ï¼‰é™é †
    if (b.coreCount !== a.coreCount) {
      return b.coreCount - a.coreCount;
    }

    // â‘¡ åŒæ•°ãªã‚‰ç¨®é¡åã§æ˜‡é †
    const aNames = a.core16.map(x => x.type).sort().join("");
    const bNames = b.core16.map(x => x.type).sort().join("");
    return aNames.localeCompare(bNames, "ja");
  });
}


/* ============================================================
   â–¼ 11. çµæœè¡¨ç¤ºï¼ˆè‰²åˆ†ã‘ãƒ»3åˆ—ï¼‰
   ============================================================ */

function renderResults() {
  const box = document.getElementById("results");
  const checked = getCheckedRecommended();

  let arr = results.slice();

  // â–¼ AND æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿
  if (checked.length > 0) {
    arr = arr.filter(r =>
      checked.every(c => r.core16.some(x => x.type === c))
    );
  }

  // â–¼ ä¸¦ã³æ›¿ãˆ
  arr = sortResults(arr);

  // â–¼ è¡¨ç¤º
  box.innerHTML = arr
    .map(r => {
      const colorClass =
        r.coreCount >= 4 ? "gold" :
        r.coreCount === 3 ? "purple" :
        r.coreCount === 2 ? "blue" : "green";

      return `
        <div class="result-card ${colorClass}">
          <b>16ä»¥ä¸Šã®ã‚³ã‚¢ï¼š${r.coreCount}å€‹</b><br>
          <div class="core-grid">
            ${r.core16
              .map(c => `<div class="core-item">${c.type} Lv${c.level}</div>`)
              .join("")}
          </div>
        </div>
      `;
    })
    .join("");
}
